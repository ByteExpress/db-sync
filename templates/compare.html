<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据库同步工具 - {{ conn_id }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <style>
        :root {
            --primary-color: #4e73df;
            --secondary-color: #6c757d;
            --success-color: #1cc88a;
            --warning-color: #f6c23e;
            --danger-color: #e74a3b;
            --light-bg: #f8f9fc;
            --dark-bg: #5a5c69;
        }
        
        body {
            background-color: #f8f9fa;
            padding-top: 20px;
            padding-bottom: 40px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color), #2e59d9);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
            border: none;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }
        
        .card-header {
            background: linear-gradient(to right, var(--primary-color), #2e59d9);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            padding: 15px 20px;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .badge {
            font-weight: 500;
            padding: 0.5em 0.8em;
            border-radius: 12px;
        }
        
        .diff-badge {
            font-size: 0.8rem;
            padding: 0.35rem 0.65rem;
            border-radius: 8px;
        }
        
        .table-container {
            border: 1px solid #e3e6f0;
            border-radius: 8px;
            background: white;
            overflow: hidden;
        }
        
        .table thead th {
            background-color: var(--light-bg);
            color: var(--primary-color);
            font-weight: 700;
            padding: 12px 15px;
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(78, 115, 223, 0.05);
        }
        
        .column-list {
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background-color: var(--light-bg);
            border-radius: 5px;
            margin: 5px 0;
        }
        
        .form-check-label {
            font-weight: 500;
        }
        
        .btn-primary {
            background: linear-gradient(to right, var(--primary-color), #2e59d9);
            border: none;
            padding: 10px 25px;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            background: linear-gradient(to right, #2e59d9, #244ec7);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(46, 89, 217, 0.3);
        }
        
        .action-bar {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }
        
        .table-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }
        
        .status-cell {
            min-width: 120px;
            text-align: center;
        }
        
        .sql-preview {
            background-color: #2d3741;
            color: #f8f8f2;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .diff-highlight {
            background-color: rgba(246, 194, 62, 0.2);
            border-left: 3px solid var(--warning-color);
            padding-left: 5px;
        }
        
        .missing-highlight {
            background-color: rgba(231, 74, 59, 0.15);
            border-left: 3px solid var(--danger-color);
            padding-left: 5px;
        }
        
        .extra-highlight {
            background-color: rgba(66, 153, 225, 0.15);
            border-left: 3px solid #4299e1;
            padding-left: 5px;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: var(--secondary-color);
            font-size: 0.9rem;
        }
        
        .legend-item {
            display: inline-flex;
            align-items: center;
            margin-right: 20px;
            font-size: 0.9rem;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            margin-right: 8px;
        }
        
        .sync-stats {
            background: linear-gradient(to right, #1cc88a, #17a673);
            color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .status-missing {
            background-color: rgba(231, 74, 59, 0.15);
        }
        
        .status-changed {
            background-color: rgba(246, 194, 62, 0.2);
        }
        
        .status-extra {
            background-color: rgba(66, 153, 225, 0.15);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 头部区域 -->
        <div class="header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-2"><i class="fas fa-database me-2"></i>数据库结构同步工具</h1>
                    <p class="mb-0">连接: <strong>{{ conn_id }}</strong> | 源数据库: {{ src_db_name }} | 目标数据库: {{ tgt_db_name }}</p>
                </div>
                <a href="/" class="btn btn-light">
                    <i class="fas fa-arrow-left me-2"></i>返回
                </a>
            </div>
        </div>
        
        <!-- 同步统计 -->
        <div class="sync-stats">
            <div class="row">
                <div class="col-md-3 text-center">
                    <h3 class="h5">表差异</h3>
                    <p class="mb-0 display-6">{{ stats.table_diff }}</p>
                </div>
                <div class="col-md-3 text-center">
                    <h3 class="h5">列差异</h3>
                    <p class="mb-0 display-6">{{ stats.column_diff }}</p>
                </div>
                <div class="col-md-3 text-center">
                    <h3 class="h5">缺失表</h3>
                    <p class="mb-0 display-6">{{ stats.missing_tables }}</p>
                </div>
                <div class="col-md-3 text-center">
                    <h3 class="h5">多余表</h3>
                    <p class="mb-0 display-6">{{ stats.extra_tables }}</p>
                </div>
            </div>
        </div>
        
        <!-- 图例 -->
        <div class="mb-4">
            <h5 class="mb-3">差异图例</h5>
            <div>
                <span class="legend-item"><span class="legend-color" style="background-color: rgba(231, 74, 59, 0.15);"></span>缺失的表/列</span>
                <span class="legend-item"><span class="legend-color" style="background-color: rgba(246, 194, 62, 0.2);"></span>结构差异</span>
                <span class="legend-item"><span class="legend-color" style="background-color: rgba(66, 153, 225, 0.15);"></span>多余的表/列</span>
                <span class="legend-item"><span class="legend-color" style="background-color: rgba(28, 200, 138, 0.15);"></span>一致</span>
            </div>
        </div>

        <!-- 操作栏 -->
        <div class="action-bar">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="h5 mb-0"><i class="fas fa-tasks me-2"></i>选择同步内容</h3>
                <div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="selectAllTables" checked>
                        <label class="form-check-label" for="selectAllTables">全选所有表</label>
                    </div>
                    <button class="btn btn-outline-secondary ms-2" id="deselectAllBtn">
                        <i class="fas fa-times me-1"></i>取消选择
                    </button>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- 源数据库 -->
            <div class="col-lg-6">
                <div class="table-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 class="h5 text-primary mb-0">
                            <i class="fas fa-arrow-circle-right me-2"></i>源数据库
                            <span class="badge bg-primary ms-2">{{ src_db_name }}</span>
                        </h3>
                        <span class="badge bg-light text-dark">
                            已选表: <span id="selectedTableCount">0</span>
                        </span>
                    </div>
                    
                    <div class="table-responsive table-container">
                        <table class="table table-hover" id="srcTable">
                            <thead class="table-light">
                                <tr>
                                    <th width="5%"></th>
                                    <th width="25%">表名</th>
                                    <th width="55%">列</th>
                                    <th width="15%" class="status-cell">状态</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for table in src_tables %}
                                <tr class="{% if table.status == 'missing' %}status-missing{% elif table.status == 'changed' %}status-changed{% endif %}">
                                    <td>
                                        <input type="checkbox" 
                                               class="form-check-input table-check" 
                                               id="table-{{ table.name }}" 
                                               data-table="{{ table.name }}"
                                               checked>
                                    </td>
                                    <td>
                                        <label class="form-check-label fw-bold" for="table-{{ table.name }}">{{ table.name }}</label>
                                    </td>
                                    <td>
                                        <div class="column-list">
                                            {% for col in table.columns %}
                                            <div class="form-check">
                                                <input type="checkbox" 
                                                       class="form-check-input column-check" 
                                                       id="col-{{ table.name }}-{{ col.name }}" 
                                                       data-table="{{ table.name }}" 
                                                       data-column="{{ col.name }}"
                                                       {% if col.status != 'extra' %}checked{% endif %}>
                                                <label class="form-check-label" for="col-{{ table.name }}-{{ col.name }}">
                                                    {{ col.name }} 
                                                    <span class="text-muted small">({{ col.type }})</span>
                                                    {% if col.status == 'missing' %}
                                                    <span class="badge bg-danger diff-badge ms-2">缺失</span>
                                                    {% elif col.status == 'changed' %}
                                                    <span class="badge bg-warning diff-badge ms-2">类型变更</span>
                                                    {% endif %}
                                                </label>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </td>
                                    <td>
                                        {% if table.status == 'missing' %}
                                        <span class="badge bg-danger">表缺失</span>
                                        {% elif table.status == 'changed' %}
                                        <span class="badge bg-warning">列差异</span>
                                        {% else %}
                                        <span class="badge bg-success">一致</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- 目标数据库 -->
            <div class="col-lg-6">
                <div class="table-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 class="h5 text-primary mb-0">
                            <i class="fas fa-arrow-circle-left me-2"></i>目标数据库
                            <span class="badge bg-primary ms-2">{{ tgt_db_name }}</span>
                        </h3>
                        <span class="badge bg-light text-dark">
                            已选列: <span id="selectedColumnCount">0</span>
                        </span>
                    </div>
                    
                    <div class="table-responsive table-container">
                        <table class="table table-hover" id="tgtTable">
                            <thead class="table-light">
                                <tr>
                                    <th width="30%">表名</th>
                                    <th width="60%">列</th>
                                    <th width="10%" class="status-cell">状态</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for table in tgt_tables %}
                                <tr class="{% if table.status == 'extra' %}status-extra{% endif %}">
                                    <td class="fw-bold">{{ table.name }}</td>
                                    <td>
                                        <div class="column-list">
                                            {% for col in table.columns %}
                                            <div>
                                                <span class="fw-medium">{{ col.name }}</span>
                                                <span class="text-muted small">({{ col.type }})</span>
                                                {% if col.status == 'extra' %}
                                                <span class="badge bg-info diff-badge ms-2">多余列</span>
                                                {% endif %}
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </td>
                                    <td>
                                        {% if table.status == 'extra' %}
                                        <span class="badge bg-info">多余表</span>
                                        {% elif table.name in diff.tables.changed %}
                                        <span class="badge bg-secondary">有差异</span>
                                        {% else %}
                                        <span class="badge bg-secondary">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 生成脚本区域 -->
        <div class="card mt-4">
            <div class="card-header">
                <i class="fas fa-file-code me-2"></i>生成同步脚本
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-4">
                            <label for="outputPath" class="form-label fw-medium">
                                <i class="fas fa-folder-open me-2"></i>脚本保存路径:
                            </label>
                            <div class="input-group">
                                <input type="text" id="outputPath" class="form-control" value="/dbsync/{{ conn_id }}_{{ now.strftime('%Y%m%d') }}.sql">
                                <button class="btn btn-outline-secondary" type="button" id="browseBtn">
                                    <i class="fas fa-folder me-1"></i> 浏览
                                </button>
                            </div>
                            <div class="form-text">留空则直接显示脚本内容</div>
                        </div>
                        
                        <div class="d-flex">
                            <button id="generateBtn" class="btn btn-primary me-3">
                                <i class="fas fa-cogs me-2"></i> 生成同步脚本
                            </button>
                            
                            <div class="d-flex align-items-center">
                                <div class="spinner-border text-primary me-2" role="status" id="loadingSpinner" style="display: none;">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                                <span id="loadingText" style="display: none;">正在生成脚本，请稍候...</span>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h5 class="mb-3"><i class="fas fa-shield-alt me-2"></i>安全选项</h5>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="safeMode" checked>
                                <label class="form-check-label" for="safeMode">安全模式（禁用删除操作）</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="backupOption">
                                <label class="form-check-label" for="backupOption">生成前备份目标数据库</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <h5 class="mb-3"><i class="fas fa-eye me-2"></i>脚本预览</h5>
                        <div class="sql-preview" id="scriptPreview">
                            <span style="color: #f92672;">-- 数据库同步脚本: {{ conn_id }}</span><br>
                            <span style="color: #f92672;">-- 生成时间: {{ now.strftime('%Y-%m-%d %H:%M:%S') }}</span><br>
                            <span style="color: #f92672;">-- 源数据库: {{ src_db_name }}</span><br>
                            <span style="color: #f92672;">-- 目标数据库: {{ tgt_db_name }}</span><br>
                            <span style="color: #f92672;">-- 状态: 等待生成...</span>
                        </div>
                    </div>
                </div>
                
                <div id="scriptResult" class="mt-4"></div>
            </div>
        </div>
        
        <div class="footer">
            <p>数据库同步工具 v1.2 &copy; {{ now.year }} | 已安全同步 {{ stats.table_diff }} 个表结构 | 最后生成时间: {{ now.strftime('%Y-%m-%d %H:%M:%S') }}</p>
        </div>
    </div>

    <!-- 脚本 -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    
    <script>
    $(document).ready(function() {
        // 初始化表格
        $('#srcTable').DataTable({
            paging: true,
            pageLength: 10,
            lengthMenu: [5, 10, 25],
            language: {
                search: "搜索表:",
                lengthMenu: "每页显示 _MENU_ 条记录",
                zeroRecords: "没有找到匹配的表",
                info: "显示第 _START_ 至 _END_ 条，共 _TOTAL_ 条",
                infoEmpty: "没有可用记录",
                paginate: {
                    first: "首页",
                    last: "末页",
                    next: "下一页",
                    previous: "上一页"
                }
            }
        });
        
        $('#tgtTable').DataTable({
            paging: true,
            pageLength: 10,
            lengthMenu: [5, 10, 25],
            language: {
                search: "搜索表:",
                lengthMenu: "每页显示 _MENU_ 条记录",
                zeroRecords: "没有找到匹配的表",
                info: "显示第 _START_ 至 _END_ 条，共 _TOTAL_ 条",
                infoEmpty: "没有可用记录",
                paginate: {
                    first: "首页",
                    last: "末页",
                    next: "下一页",
                    previous: "上一页"
                }
            }
        });
        
        // 更新选择计数
        function updateSelectionCount() {
            const tableCount = $('.table-check:checked').length;
            const columnCount = $('.column-check:checked').length;
            $('#selectedTableCount').text(tableCount);
            $('#selectedColumnCount').text(columnCount);
        }
        
        // 表全选逻辑
        $('#selectAllTables').change(function() {
            const isChecked = $(this).prop('checked');
            $('.table-check').prop('checked', isChecked).trigger('change');
            updateSelectionCount();
        });
        
        // 取消全选
        $('#deselectAllBtn').click(function() {
            $('.table-check, .column-check').prop('checked', false);
            $('#selectAllTables').prop('checked', false);
            updateSelectionCount();
        });
        
        // 表选择逻辑
        $('.table-check').change(function() {
            const table = $(this).data('table');
            const isChecked = $(this).prop('checked');
            $(`.column-check[data-table="${table}"]`).prop('checked', isChecked);
            updateSelectionCount();
        });
        
        // 列选择逻辑
        $('.column-check').change(function() {
            const table = $(this).data('table');
            const allChecked = $(`.column-check[data-table="${table}"]:checked`).length === 
                              $(`.column-check[data-table="${table}"]`).length;
            $(`#table-${table}`).prop('checked', allChecked);
            updateSelectionCount();
        });
        
        // 初始化计数
        updateSelectionCount();
        
        // 生成脚本
        $('#generateBtn').click(function() {
            const $btn = $(this);
            const originalText = $btn.html();
            const $spinner = $('#loadingSpinner');
            const $loadingText = $('#loadingText');
            
            // 禁用按钮并显示加载指示器
            $btn.prop('disabled', true);
            $btn.html('<i class="fas fa-spinner fa-spin me-2"></i> 生成中...');
            $spinner.show();
            $loadingText.show();
            
            // 更新预览状态
            $('#scriptPreview').html(`
                <span style="color: #f92672;">-- 数据库同步脚本: {{ conn_id }}</span><br>
                <span style="color: #f92672;">-- 生成时间: ${new Date().toLocaleString()}</span><br>
                <span style="color: #f92672;">-- 状态: 正在生成脚本...</span>
            `);
            
            // 清除之前的结果
            $('#scriptResult').html('');
            
            // 收集选中的表和列
            const selectedTables = [];
            const selectedColumns = {};
            
            $('.table-check:checked').each(function() {
                const table = $(this).data('table');
                selectedTables.push(table);
                
                // 收集该表选中的列
                selectedColumns[table] = [];
                $(`.column-check[data-table="${table}"]:checked`).each(function() {
                    selectedColumns[table].push($(this).data('column'));
                });
            });
            
            const outputPath = $('#outputPath').val();
            const safeMode = $('#safeMode').prop('checked');
            const backupOption = $('#backupOption').prop('checked');
            
            // AJAX请求生成脚本
            $.ajax({
                url: '/generate',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    conn_id: "{{ conn_id }}",
                    tables: selectedTables,
                    columns: selectedColumns,
                    output_path: outputPath,
                    safe_mode: safeMode,
                    backup: backupOption
                }),
                success: function(response) {
                    if(response.status === "saved") {
                        const resultHtml = `
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle me-2"></i>
                                <strong>同步脚本生成成功!</strong> 脚本已保存至: <code>${response.path}</code>
                                <div class="mt-3">
                                    <button class="btn btn-outline-secondary copy-btn">
                                        <i class="fas fa-copy me-1"></i>复制到剪贴板
                                    </button>
                                    <button class="btn btn-outline-primary" id="saveToFileBtn">
                                        <i class="fas fa-download me-1"></i>下载脚本
                                    </button>
                                    <button class="btn btn-success" id="executeBtn">
                                        <i class="fas fa-play me-1"></i>执行同步
                                    </button>
                                </div>
                            </div>
                        `;
                        $('#scriptResult').html(resultHtml);
                        
                        // 显示生成的脚本内容
                        $.ajax({
                            url: '/read_script',
                            method: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({path: response.path}),
                            success: function(content) {
                                $('#scriptResult').html(`
                                    <div class="alert alert-success">
                                        <i class="fas fa-check-circle me-2"></i>
                                        <strong>同步脚本生成成功!</strong> 脚本已保存至: <code>${response.path}</code>
                                        <div class="mt-3">
                                            <pre class="sql-preview">${content.script}</pre>
                                            <div class="d-flex justify-content-between mt-3">
                                                <button class="btn btn-outline-secondary copy-btn">
                                                    <i class="fas fa-copy me-1"></i>复制到剪贴板
                                                </button>
                                                <button class="btn btn-outline-primary" id="saveToFileBtn">
                                                    <i class="fas fa-download me-1"></i>下载脚本
                                                </button>
                                                <button class="btn btn-success" id="executeBtn">
                                                    <i class="fas fa-play me-1"></i>执行同步
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `);
                                
                                // 更新预览
                                $('#scriptPreview').html(content.script.replace(/\n/g, '<br>'));
                                
                                // 复制功能
                                $('.copy-btn').click(function() {
                                    navigator.clipboard.writeText(content.script);
                                    $(this).html('<i class="fas fa-check me-1"></i>已复制');
                                    setTimeout(() => {
                                        $(this).html('<i class="fas fa-copy me-1"></i>复制到剪贴板');
                                    }, 2000);
                                });
                                
                                // 下载脚本
                                $('#saveToFileBtn').click(function() {
                                    const a = document.createElement('a');
                                    a.href = 'data:text/plain;charset=utf-8,' + encodeURIComponent(content.script);
                                    a.download = response.path.split('/').pop();
                                    document.body.appendChild(a);
                                    a.click();
                                    document.body.removeChild(a);
                                });
                                
                                // 执行按钮
                                $('#executeBtn').click(function() {
                                    $btn.html('<i class="fas fa-spinner fa-spin me-2"></i> 执行中...');
                                    $.ajax({
                                        url: '/execute_script',
                                        method: 'POST',
                                        contentType: 'application/json',
                                        data: JSON.stringify({
                                            conn_id: "{{ conn_id }}",
                                            script: content.script
                                        }),
                                        success: function() {
                                            alert('同步脚本执行成功！数据库结构已更新。');
                                        },
                                        error: function() {
                                            alert('脚本执行失败，请检查日志');
                                        },
                                        complete: function() {
                                            $btn.html(originalText);
                                        }
                                    });
                                });
                            }
                        });
                    } else if(response.script) {
                        $('#scriptResult').html(`
                            <div class="alert alert-info">
                                <h5>生成的SQL脚本:</h5>
                                <pre class="sql-preview">${response.script}</pre>
                                <div class="d-flex justify-content-between mt-3">
                                    <button class="btn btn-outline-secondary copy-btn">
                                        <i class="fas fa-copy me-1"></i>复制到剪贴板
                                    </button>
                                    <button class="btn btn-outline-primary" id="saveToFileBtn">
                                        <i class="fas fa-download me-1"></i>下载脚本
                                    </button>
                                    <button class="btn btn-success" id="executeBtn">
                                        <i class="fas fa-play me-1"></i>执行同步
                                    </button>
                                </div>
                            </div>
                        `);
                        
                        // 更新预览
                        $('#scriptPreview').html(response.script.replace(/\n/g, '<br>'));
                        
                        // 复制功能
                        $('.copy-btn').click(function() {
                            navigator.clipboard.writeText(response.script);
                            $(this).html('<i class="fas fa-check me-1"></i>已复制');
                            setTimeout(() => {
                                $(this).html('<i class="fas fa-copy me-1"></i>复制到剪贴板');
                            }, 2000);
                        });
                        
                        // 下载脚本
                        $('#saveToFileBtn').click(function() {
                            const a = document.createElement('a');
                            a.href = 'data:text/plain;charset=utf-8,' + encodeURIComponent(response.script);
                            a.download = 'sync_script.sql';
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                        });
                        
                        // 执行按钮
                        $('#executeBtn').click(function() {
                            $btn.html('<i class="fas fa-spinner fa-spin me-2"></i> 执行中...');
                            $.ajax({
                                url: '/execute_script',
                                method: 'POST',
                                contentType: 'application/json',
                                data: JSON.stringify({
                                    conn_id: "{{ conn_id }}",
                                    script: response.script
                                }),
                                success: function() {
                                    alert('同步脚本执行成功！数据库结构已更新。');
                                },
                                error: function() {
                                    alert('脚本执行失败，请检查日志');
                                },
                                complete: function() {
                                    $btn.html(originalText);
                                }
                            });
                        });
                    }
                },
                error: function(xhr) {
                    const errorMsg = xhr.responseJSON?.message || "生成脚本时出错";
                    $('#scriptResult').html(`
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>错误!</strong> ${errorMsg}
                        </div>
                    `);
                    $('#scriptPreview').html(`
                        <span style="color: #f92672;">-- 数据库同步脚本: {{ conn_id }}</span><br>
                        <span style="color: #f92672;">-- 状态: 生成失败</span><br>
                        <span style="color: #e74a3b;">-- 错误: ${errorMsg}</span>
                    `);
                },
                complete: function() {
                    // 恢复按钮状态
                    $btn.prop('disabled', false);
                    $btn.html(originalText);
                    $spinner.hide();
                    $loadingText.hide();
                }
            });
        });
        
        // 浏览按钮
        $('#browseBtn').click(function() {
            const path = prompt("请输入脚本保存路径:", "/dbsync/{{ conn_id }}_{{ now.strftime('%Y%m%d') }}.sql");
            if (path) {
                $('#outputPath').val(path);
            }
        });
    });
    </script>
</body>
</html>